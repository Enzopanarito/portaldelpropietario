<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Gesti√≥n: Villa Los Apamates</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .nav-button.active {
            background-color: #0284c7;
            color: white;
        }
        .section-content { display: none; }
        .section-content.active { display: block; }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .toast { 
            transition: opacity 0.5s, transform 0.5s; 
            z-index: 9999;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #0ea5e9;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .payment-tab {
            cursor: pointer;
            padding: 10px 15px;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .payment-tab.active {
            border-bottom-color: #0284c7;
            color: #0284c7;
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .input-error {
            border-color: #ef4444; /* red-500 */
            ring-color: #ef4444;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Portal de Gesti√≥n: Villa Los Apamates</h1>
            <p class="mt-2 text-lg text-slate-600">Un centro de comando con c√°lculos autom√°ticos e inteligencia artificial.</p>
        </header>

        <nav class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
            <button data-target="dashboard" class="nav-button active text-sm sm:text-base font-semibold py-2 px-4 rounded-full bg-white text-slate-700 shadow-sm hover:bg-slate-100">
                üìä Dashboard
            </button>
            <button data-target="management" class="nav-button text-sm sm:text-base font-semibold py-2 px-4 rounded-full bg-white text-slate-700 shadow-sm hover:bg-slate-100">
                ‚öôÔ∏è Gesti√≥n de Propietarios
            </button>
            <button data-target="expenses" class="nav-button text-sm sm:text-base font-semibold py-2 px-4 rounded-full bg-white text-slate-700 shadow-sm hover:bg-slate-100">
                üí∏ Gesti√≥n de Gastos
            </button>
        </nav>

        <main>
            <section id="dashboard" class="section-content active">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-1">
                        <h2 class="text-2xl font-bold text-slate-900">Resumen Financiero del Condominio</h2>
                        <div class="flex gap-2">
                            <button id="generate-announcement-modal-btn" class="bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200 transition-colors whitespace-nowrap text-center text-sm">
                                ‚ú® Redactar Anuncio
                            </button>
                            <button id="generate-summary-btn" class="bg-sky-100 text-sky-700 font-semibold py-2 px-4 rounded-lg hover:bg-sky-200 transition-colors whitespace-nowrap text-center text-sm">
                                ‚ú® Generar Resumen
                            </button>
                        </div>
                    </div>
                    <p class="text-slate-600 mb-6">Una vista en tiempo real del estado de la comunidad.</p>
                    
                    <div id="ai-summary-container" class="hidden bg-slate-50 p-4 rounded-lg mb-6 border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-2">An√°lisis IA del Estado Financiero:</h3>
                        <div id="ai-summary-content" class="text-slate-700 text-sm"></div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 text-center mb-8">
                        <div class="kpi-card bg-slate-100 p-4 rounded-xl">
                            <p class="text-sm text-slate-500 font-medium">üí∞ Deuda Total (a hoy)</p>
                            <p id="kpi-deuda-total" class="text-3xl font-bold text-sky-600">$0.00</p>
                        </div>
                        <div class="kpi-card bg-slate-100 p-4 rounded-xl">
                            <p class="text-sm text-slate-500 font-medium">üè† Propietarios en Mora</p>
                            <p id="kpi-propietarios-mora" class="text-3xl font-bold text-red-500">0 / 15</p>
                        </div>
                        <div class="kpi-card bg-slate-100 p-4 rounded-xl">
                            <p class="text-sm text-slate-500 font-medium">üìà % de Solvencia</p>
                            <p id="kpi-solvencia" class="text-3xl font-bold text-green-500">0%</p>
                        </div>
                        <div class="kpi-card bg-slate-100 p-4 rounded-xl">
                            <p class="text-sm text-slate-500 font-medium">üí∏ Total a Cobrar (Mes)</p>
                            <p id="kpi-cobrar-mes" class="text-3xl font-bold text-slate-800">$0.00</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-2 bg-slate-50 p-4 rounded-xl">
                            <h3 class="text-lg font-semibold mb-2 text-slate-800">Estado de la Comunidad</h3>
                            <div class="chart-container relative h-64 w-full max-w-sm mx-auto">
                                <canvas id="solvencyChart"></canvas>
                            </div>
                        </div>
                        <div class="lg:col-span-3 bg-slate-50 p-4 rounded-xl">
                            <h3 class="text-lg font-semibold mb-2 text-slate-800">Top 5 Deudores (Monto a hoy)</h3>
                             <div class="chart-container relative h-64 w-full">
                                <canvas id="topDebtorsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="management" class="section-content">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold mb-1 text-slate-900">Gesti√≥n de Propietarios</h2>
                            <p class="text-slate-600">Visualiza deudas, registra pagos y env√≠a recordatorios desde un solo lugar.</p>
                        </div>
                        <button id="update-monthly-charges-btn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors whitespace-nowrap text-center">
                            üîÑ Actualizar Cargos del Mes
                        </button>
                    </div>
                    <div id="date-info-banner" class="bg-amber-100 border-l-4 border-amber-500 text-amber-700 p-4 rounded-r-lg mb-6">
                        <h4 class="font-bold">Informaci√≥n de Fecha</h4>
                        <p class="text-sm">
                            Hoy es <span id="current-date-display" class="font-semibold"></span>. El beneficio por pronto pago aplica hasta el d√≠a 10 del mes en curso.
                        </p>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="searchInput" placeholder="üîé Buscar por nombre o n√∫mero de casa..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div class="overflow-x-auto">
                        <table id="debtorsTable" class="min-w-full bg-white divide-y divide-slate-200">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Casa</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Propietario</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Deuda Restante</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="debtorsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="expenses" class="section-content">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold mb-1 text-slate-900">Gesti√≥n de Gastos del Mes</h2>
                            <p class="text-slate-600">A√±ade, visualiza y elimina los gastos comunes del mes en curso.</p>
                        </div>
                        <a href="https://airtable.com/app4nE4ReGRi2SuP2/tbls2S6L1p2a3r4b5" target="_blank" class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors whitespace-nowrap text-center">
                            Ver en Airtable
                        </a>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-800 mb-4">A√±adir Nuevo Gasto</h3>
                            <form id="add-expense-form" class="space-y-4">
                                <div>
                                    <label for="expense-concept" class="block text-sm font-medium text-slate-700">Concepto</label>
                                    <input type="text" id="expense-concept" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="Ej: Mantenimiento de bomba, Gasoil">
                                </div>
                                <div>
                                    <label for="expense-amount" class="block text-sm font-medium text-slate-700">Monto ($)</label>
                                    <input type="number" id="expense-amount" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="Ej: 150.50" step="0.01">
                                </div>
                                <div>
                                    <label for="expense-type" class="block text-sm font-medium text-slate-700">Tipo de Gasto</label>
                                    <select id="expense-type" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                                        <option>Gasto Com√∫n</option>
                                        <option>Gasto Especial</option>
                                    </select>
                                </div>
                                <div id="expense-owners-container">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-medium text-slate-700">Propietarios a Cobrar</label>
                                        <button type="button" id="toggle-all-owners" class="text-xs text-sky-600 font-semibold hover:underline">Deseleccionar Todos</button>
                                    </div>
                                    <div id="expense-owners-list" class="mt-2 max-h-40 overflow-y-auto rounded-md border border-slate-300 p-2 space-y-2">
                                        <!-- Checkboxes will be inserted here by JS -->
                                    </div>
                                </div>
                                <div>
                                    <label for="expense-frequency" class="block text-sm font-medium text-slate-700">Frecuencia</label>
                                    <select id="expense-frequency" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                                        <option>Eventual</option>
                                        <option>Fijo</option>
                                    </select>
                                </div>
                                <button type="submit" class="w-full py-2 px-4 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition-colors">
                                    A√±adir Gasto
                                </button>
                            </form>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-slate-800">Gastos Registrados</h3>
                                <button id="analyze-expenses-btn" class="bg-teal-100 text-teal-700 font-semibold py-1 px-3 rounded-lg hover:bg-teal-200 transition-colors text-sm">
                                    ‚ú® Analizar Gastos
                                </button>
                            </div>
                            <div class="overflow-y-auto max-h-96 border rounded-lg">
                                <table id="expensesTable" class="min-w-full bg-white divide-y divide-slate-200">
                                    <thead class="bg-slate-50 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Concepto</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Monto</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Tipo</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="expensesTableBody" class="bg-white divide-y divide-slate-200">
                                        <!-- Los gastos se insertar√°n aqu√≠ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-12">
            <p class="text-sm text-slate-500">Prototipo generado para el Condominio Villa Los Apamates. ¬© 2025</p>
        </footer>
    </div>

    <!-- Modales -->
    <div id="debtModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-95 opacity-0" id="debtModalContent">
            <div class="p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-xl font-bold text-slate-900" id="debtModal-title">Desglose de Deuda</h3>
                        <p class="text-slate-600" id="debtModal-subtitle"></p>
                    </div>
                    <button id="closeDebtModalBtn" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                </div>
                <div class="mt-4 border-t border-slate-200 pt-4 max-h-80 overflow-y-auto">
                    <ul class="space-y-2" id="debtModal-list"></ul>
                    <div class="mt-4 pt-4 border-t border-slate-200 flex justify-between items-center">
                        <span class="text-lg font-semibold text-slate-500">TOTAL A PAGAR HOY</span>
                        <span class="text-2xl font-bold text-sky-600" id="debtModal-total">$0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="reminderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-95 opacity-0" id="reminderModalContent">
             <div class="p-6">
                 <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-slate-900">Vista Previa del Mensaje</h3>
                    <button id="closeReminderModalBtn" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                </div>
                <button id="generate-reminder-btn" class="w-full mb-4 bg-sky-100 text-sky-700 font-semibold py-2 px-4 rounded-lg hover:bg-sky-200 transition-colors text-sm">
                    ‚ú® Generar Mensaje con IA
                </button>
                <div id="reminder-message-container" class="mt-4 bg-slate-50 rounded-lg p-4 border border-slate-200 min-h-[150px]">
                    <pre class="whitespace-pre-wrap text-sm text-slate-700" id="reminder-message-content" style="font-family: inherit;"></pre>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancelSendBtn" class="py-2 px-4 bg-slate-200 text-slate-800 font-semibold rounded-lg hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button id="send-whatsapp-btn" class="flex items-center gap-2 py-2 px-4 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-whatsapp" viewBox="0 0 16 16">
                            <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                        </svg>
                        Enviar por WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Registro de Pago -->
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-95 opacity-0" id="paymentModalContent">
             <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-slate-900">Registrar Pago</h3>
                    <button id="closePaymentModalBtn" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                </div>
                <div id="payment-modal-info" class="mb-4 text-sm"></div>
                
                <div class="border-b border-slate-200">
                    <nav class="-mb-px flex gap-6" aria-label="Tabs">
                        <span id="tab-total" class="payment-tab active">Pago Total</span>
                        <span id="tab-partial" class="payment-tab">Pago Parcial</span>
                    </nav>
                </div>

                <div id="content-total" class="tab-content active mt-4">
                    <p class="text-slate-600">Esta acci√≥n registrar√° un pago por el total de la deuda restante. ¬øDesea continuar?</p>
                </div>

                <div id="content-partial" class="tab-content mt-4">
                    <label for="partial-amount" class="block text-sm font-medium text-slate-700">Monto del Abono:</label>
                    <input type="number" id="partial-amount" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="Ej: 50.00">
                </div>

                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancelPaymentBtn" class="py-2 px-4 bg-slate-200 text-slate-800 font-semibold rounded-lg hover:bg-slate-300 transition-colors">Cancelar</button>
                    <button id="confirmPaymentBtn" class="py-2 px-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors">Registrar Pago</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de An√°lisis de Gastos -->
    <div id="analysisModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all scale-95 opacity-0" id="analysisModalContent">
             <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-slate-900">An√°lisis de Gastos del Mes</h3>
                    <button id="closeAnalysisModalBtn" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                </div>
                <div id="analysis-content" class="mt-4 bg-slate-50 rounded-lg p-4 border border-slate-200 min-h-[250px] max-h-[60vh] overflow-y-auto text-sm text-slate-700 whitespace-pre-wrap">
                    <!-- Contenido del an√°lisis se inserta aqu√≠ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Generador de Anuncios -->
    <div id="announcementModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all scale-95 opacity-0" id="announcementModalContent">
             <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-slate-900">Generador de Anuncios</h3>
                    <button id="closeAnnouncementModalBtn" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="announcement-topic" class="block text-sm font-medium text-slate-700">Tema del Anuncio</label>
                        <input type="text" id="announcement-topic" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="Ej: Mantenimiento de la piscina, Reuni√≥n de condominio, Recordatorio de seguridad">
                    </div>
                    <button id="generate-announcement-btn" class="w-full flex justify-center items-center gap-2 py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">
                        ‚ú® Generar Anuncio con IA
                    </button>
                    <div>
                        <label for="announcement-result" class="block text-sm font-medium text-slate-700">Anuncio Generado</label>
                        <textarea id="announcement-result" rows="8" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transform translate-y-10 toast">
        <!-- Mensaje del toast se inserta con JS -->
    </div>

    <script>
        // --- CONFIGURACI√ìN DE CONEXI√ìN ---
        const AIRTABLE_TABLE_PROPIETARIOS = 'Propietarios';
        const AIRTABLE_TABLE_GASTOS = 'Gastos del Mes';
        const AIRTABLE_TABLE_PAGOS = 'Pagos';
        
        let condominioData = [];
        let gastosDelMes = [];
        let solvencyChart, topDebtorsChart;
        let currentPropertyIdForAction = null;
        
        const TASA_DESCUENTO = 0.10;
        const DIA_LIMITE_PAGO = 10;
        
        const FECHA_ACTUAL = new Date();
        const DIA_ACTUAL = FECHA_ACTUAL.getDate();

        // --- Gemini API Helper ---
        async function callGemini(prompt) {
            try {
                const response = await fetch('/.netlify/functions/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Unexpected API response structure:", result);
                    return "No se pudo generar el texto. Int√©ntalo de nuevo.";
                }
            } catch (error) {
                console.error("Error calling Gemini function:", error);
                return "Error de conexi√≥n con el servicio de IA.";
            }
        }

        // --- Airtable API Helpers ---
        async function airtableFetch(path, options = {}) {
            const url = `/.netlify/functions/airtable${path}`;
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Error de Airtable: ${errorData.error?.message || response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Error en airtableFetch:", error);
                throw error;
            }
        }

        async function updateAirtableRecords(tableName, recordsToUpdate) {
            return airtableFetch(`/${encodeURIComponent(tableName)}`, {
                method: 'PATCH',
                body: JSON.stringify({ records: recordsToUpdate })
            });
        }

        async function createAirtableRecord(tableName, fieldsToCreate) {
            return airtableFetch(`/${encodeURIComponent(tableName)}`, {
                method: 'POST',
                body: JSON.stringify({ records: [{ fields: fieldsToCreate }] })
            });
        }

        async function deleteAirtableRecord(tableName, recordId) {
            return airtableFetch(`/${encodeURIComponent(tableName)}/${recordId}`, {
                method: 'DELETE'
            });
        }
        
        async function initApp() {
            try {
                const [propietariosData, gastosData] = await Promise.all([
                    airtableFetch(`/${encodeURIComponent(AIRTABLE_TABLE_PROPIETARIOS)}`),
                    airtableFetch(`/${encodeURIComponent(AIRTABLE_TABLE_GASTOS)}?view=Gastos%20Mensuales`)
                ]);

                gastosDelMes = gastosData.records || [];
                condominioData = propietariosData.records.map(r => ({ id: r.id, ...r.fields }));
                condominioData.sort((a, b) => (a.Casa || 0) - (b.Casa || 0));
                
                setupUI();
                updateDashboard();
                populateTable(condominioData);
                populateExpensesTable(gastosDelMes);
                populateOwnerSelector();

            } catch (error) {
                alert(`Hubo un error al cargar los datos: ${error.message}. Revisa la consola (F12) para m√°s detalles.`);
            }
        }

        function setupUI() {
            document.getElementById('current-date-display').textContent = FECHA_ACTUAL.toLocaleDateString('es-VE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function calculateCurrentMonthCharges(property) {
            const gastosRecords = gastosDelMes;

            let cuotaComun = 0;
            const gastosComunes = gastosRecords.filter(g => g.fields['Tipo de Gasto'] === 'Gasto Com√∫n');
            gastosComunes.forEach(gasto => {
                const assignedOwners = gasto.fields['Propietarios'] || [];
                if (assignedOwners.includes(property.id)) {
                    cuotaComun += (gasto.fields.Monto || 0) * (property.Alicuota || 0);
                }
            });

            let cuotaEspecial = 0;
            const gastosEspeciales = gastosRecords.filter(g => g.fields['Tipo de Gasto'] === 'Gasto Especial');
            
            gastosEspeciales.forEach(gasto => {
                const assignedOwners = gasto.fields['Propietarios'] || [];
                if (assignedOwners.includes(property.id)) {
                    const numAssigned = assignedOwners.length;
                    const expenseAmount = gasto.fields.Monto || 0;
                    if (numAssigned > 0) {
                        cuotaEspecial += expenseAmount / numAssigned;
                    }
                }
            });
            
            let beneficio = 0;
            if (DIA_ACTUAL <= DIA_LIMITE_PAGO) {
                beneficio = cuotaComun * TASA_DESCUENTO;
            }
            
            return { cuotaComun, cuotaEspecial, beneficio };
        }

        function updateDashboard() {
            let deudaTotal = 0;
            let morosos = 0;
            let totalACobrarMes = 0;

            condominioData.forEach(p => {
                const deudaRestante = p['Deuda Restante'] || 0;
                if (deudaRestante > 0.01) {
                    deudaTotal += deudaRestante;
                    morosos++;
                }
                const { cuotaComun, cuotaEspecial } = calculateCurrentMonthCharges(p);
                totalACobrarMes += cuotaComun + cuotaEspecial;
            });
            const solventes = condominioData.length - morosos;

            document.getElementById('kpi-deuda-total').textContent = `$${deudaTotal.toFixed(2)}`;
            document.getElementById('kpi-propietarios-mora').textContent = `${morosos} / ${condominioData.length}`;
            document.getElementById('kpi-solvencia').textContent = `${((solventes / condominioData.length) * 100).toFixed(0)}%`;
            document.getElementById('kpi-cobrar-mes').textContent = `$${totalACobrarMes.toFixed(2)}`;
            
            createCharts(solventes, morosos);
        }

        function populateTable(data) {
            const tableBody = document.getElementById('debtorsTableBody');
            tableBody.innerHTML = '';
            data.forEach(item => {
                const deudaRestante = item['Deuda Restante'] || 0;
                const isSolvent = deudaRestante < 0.01;
                const row = tableBody.insertRow();
                row.dataset.propertyId = item.id;
                row.className = "table-row";
                
                let actionsHtml = `<button data-id="${item.id}" class="view-breakdown-btn font-semibold text-sky-600 hover:text-sky-800">Desglose</button>`;
                if (!isSolvent) {
                    actionsHtml += `
                        <button data-id="${item.id}" class="send-reminder-btn font-semibold text-amber-600 hover:text-amber-800">Recordatorio</button>
                        <button data-id="${item.id}" class="register-payment-btn font-semibold text-green-600 hover:text-green-800" title="Registrar Pago">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cash-stack inline-block" viewBox="0 0 16 16"><path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zm12 11a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1zM2 6.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5"/><path d="M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2M1 2a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1z"/></svg>
                        </button>
                    `;
                }

                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap"><span class="font-semibold text-slate-900">${item.Casa || ''}</span></td>
                    <td class="px-4 py-3 whitespace-nowrap">${item.Propietario || ''}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-medium ${isSolvent ? 'text-green-600' : 'text-red-600'}">$${deudaRestante.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm space-x-3">${actionsHtml}</td>
                `;
            });
        }

        function populateExpensesTable(data) {
            const tableBody = document.getElementById('expensesTableBody');
            tableBody.innerHTML = '';
            if (!data || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-slate-500">No hay gastos registrados este mes.</td></tr>`;
                return;
            }
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700">${item.fields.Concepto || ''}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-700">$${(item.fields.Monto || 0).toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-500">${item.fields['Tipo de Gasto'] || ''}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-right">
                        <button data-id="${item.id}" class="delete-expense-btn text-red-500 hover:text-red-700 text-xl font-bold">
                            &times;
                        </button>
                    </td>
                `;
            });
        }

        function populateOwnerSelector() {
            const ownerListDiv = document.getElementById('expense-owners-list');
            ownerListDiv.innerHTML = '';
            condominioData.forEach(owner => {
                const ownerId = owner.id;
                const ownerName = owner.Propietario || `Casa ${owner.Casa}`;
                const checkboxHtml = `
                    <div class="flex items-center">
                        <input id="owner-${ownerId}" type="checkbox" value="${ownerId}" class="h-4 w-4 rounded border-gray-300 text-sky-600 focus:ring-sky-500">
                        <label for="owner-${ownerId}" class="ml-3 block text-sm text-slate-700">${ownerName}</label>
                    </div>
                `;
                ownerListDiv.insertAdjacentHTML('beforeend', checkboxHtml);
            });
            // Initially select all for "Gasto Com√∫n"
            document.querySelectorAll('#expense-owners-list input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function createCharts(solventes, morosos) {
            if (solvencyChart) solvencyChart.destroy();
            const solvencyCtx = document.getElementById('solvencyChart').getContext('2d');
            solvencyChart = new Chart(solvencyCtx, { type: 'doughnut', data: { labels: ['Solventes', 'En Mora'], datasets: [{ data: [solventes, morosos], backgroundColor: ['#22c55e', '#ef4444'], borderColor: '#ffffff', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } } });
            
            if (topDebtorsChart) topDebtorsChart.destroy();
            const topDebtors = condominioData.filter(p => (p['Deuda Restante'] || 0) > 0).sort((a, b) => b['Deuda Restante'] - a['Deuda Restante']).slice(0, 5);
            const topDebtorsCtx = document.getElementById('topDebtorsChart').getContext('2d');
            topDebtorsChart = new Chart(topDebtorsCtx, { type: 'bar', data: { labels: topDebtors.map(d => `Casa ${d.Casa}`), datasets: [{ label: 'Deuda ($)', data: topDebtors.map(d => d['Deuda Restante']), backgroundColor: '#38bdf8', borderRadius: 6 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        }

        function showDebtModal(propertyId) {
            const property = condominioData.find(p => p.id === propertyId);
            if (!property) return;
            
            const { cuotaComun, cuotaEspecial, beneficio } = calculateCurrentMonthCharges(property);
            const totalPagarHoy = property['Deuda Restante'] || 0;
            const deudaAnterior = property['Deuda Anterior'] || 0;

            document.getElementById('debtModal-subtitle').textContent = `Casa ${property.Casa} - ${property.Propietario}`;
            const debtList = document.getElementById('debtModal-list');
            
            let htmlContent = `<li class="flex justify-between"><span>Saldo del mes anterior</span><span class="font-medium">$${deudaAnterior.toFixed(2)}</span></li>`;
            htmlContent += `<li class="flex justify-between"><span>Cuota Com√∫n del Mes</span><span class="font-medium">$${cuotaComun.toFixed(2)}</span></li>`;
            
            if (cuotaEspecial > 0) {
                 htmlContent += `<li class="flex justify-between"><span>Cargos Especiales</span><span class="font-medium">$${cuotaEspecial.toFixed(2)}</span></li>`;
            }
            
            if (beneficio > 0) {
                htmlContent += `<li class="flex justify-between text-green-600"><span>(Beneficio por Pronto Pago)</span><span class="font-medium">-$${beneficio.toFixed(2)}</span></li>`;
            }

            debtList.innerHTML = htmlContent;
            document.getElementById('debtModal-total').textContent = `$${totalPagarHoy.toFixed(2)}`;
            showModal(debtModal, document.getElementById('debtModalContent'));
        }

        function showReminderModal(propertyId) {
            currentPropertyIdForAction = propertyId;
            document.getElementById('reminder-message-content').innerHTML = '<span class="text-slate-400">Haz clic en el bot√≥n para generar un mensaje...</span>';
            showModal(reminderModal, document.getElementById('reminderModalContent'));
        }

        function showPaymentModal(propertyId) {
            currentPropertyIdForAction = propertyId;
            const property = condominioData.find(p => p.id === propertyId);
            if (!property) return;
            const deudaRestante = property['Deuda Restante'] || 0;
            document.getElementById('payment-modal-info').innerHTML = `
                <p>Propietario: <span class="font-semibold">${property.Propietario}</span></p>
                <p>Deuda Actual: <span class="font-semibold">$${deudaRestante.toFixed(2)}</span></p>
            `;
            document.getElementById('partial-amount').value = '';
            showModal(paymentModal, document.getElementById('paymentModalContent'));
        }

        function showModal(modal, content) {
            modal.style.display = 'flex';
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                modal.classList.remove('opacity-0');
            }, 10);
        }

        function hideModal(modal, content) {
            content.classList.add('scale-95', 'opacity-0');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transform translate-y-10 toast ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-10'), 4000);
        }
        
        // --- Event Listeners ---
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.currentTarget.dataset.target;
                document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                e.currentTarget.classList.add('active');
                document.querySelectorAll('.section-content').forEach(section => {
                    section.classList.remove('active');
                    if (section.id === targetId) section.classList.add('active');
                });
            });
        });

        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const filter = e.target.value.toLowerCase();
            const filteredData = condominioData.filter(p => 
                (p.Propietario || '').toLowerCase().includes(filter) || 
                (p.Casa || '').toString().toLowerCase().includes(filter)
            );
            populateTable(filteredData);
        });

        document.getElementById('debtorsTableBody').addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const propertyId = target.dataset.id;
            if (target.classList.contains('view-breakdown-btn')) {
                showDebtModal(propertyId);
            } else if (target.classList.contains('send-reminder-btn')) {
                showReminderModal(propertyId);
            } else if (target.classList.contains('register-payment-btn')) {
                showPaymentModal(propertyId);
            }
        });

        const debtModalEl = document.getElementById('debtModal');
        const debtModalContentEl = document.getElementById('debtModalContent');
        const reminderModalEl = document.getElementById('reminderModal');
        const reminderModalContentEl = document.getElementById('reminderModalContent');
        const paymentModalEl = document.getElementById('paymentModal');
        const paymentModalContentEl = document.getElementById('paymentModalContent');
        const analysisModalEl = document.getElementById('analysisModal');
        const analysisModalContentEl = document.getElementById('analysisModalContent');
        const announcementModalEl = document.getElementById('announcementModal');
        const announcementModalContentEl = document.getElementById('announcementModalContent');


        document.getElementById('closeDebtModalBtn').addEventListener('click', () => hideModal(debtModalEl, debtModalContentEl));
        debtModalEl.addEventListener('click', (e) => { if (e.target === debtModalEl) hideModal(debtModalEl, debtModalContentEl); });
        
        document.getElementById('closeReminderModalBtn').addEventListener('click', () => hideModal(reminderModalEl, reminderModalContentEl));
        document.getElementById('cancelSendBtn').addEventListener('click', () => hideModal(reminderModalEl, reminderModalContentEl));
        
        document.getElementById('closePaymentModalBtn').addEventListener('click', () => hideModal(paymentModalEl, paymentModalContentEl));
        document.getElementById('cancelPaymentBtn').addEventListener('click', () => hideModal(paymentModalEl, paymentModalContentEl));
        paymentModalEl.addEventListener('click', (e) => { if (e.target === paymentModalEl) hideModal(paymentModalEl, paymentModalContentEl); });
        
        document.getElementById('closeAnalysisModalBtn').addEventListener('click', () => hideModal(analysisModalEl, analysisModalContentEl));
        analysisModalEl.addEventListener('click', (e) => { if (e.target === analysisModalEl) hideModal(analysisModalEl, analysisModalContentEl); });

        document.getElementById('closeAnnouncementModalBtn').addEventListener('click', () => hideModal(announcementModalEl, announcementModalContentEl));
        announcementModalEl.addEventListener('click', (e) => { if (e.target === announcementModalEl) hideModal(announcementModalEl, announcementModalContentEl); });


        // Payment Modal Tabs
        const tabTotal = document.getElementById('tab-total');
        const tabPartial = document.getElementById('tab-partial');
        const contentTotal = document.getElementById('content-total');
        const contentPartial = document.getElementById('content-partial');

        tabTotal.addEventListener('click', () => {
            tabTotal.classList.add('active');
            tabPartial.classList.remove('active');
            contentTotal.classList.add('active');
            contentPartial.classList.remove('active');
        });

        tabPartial.addEventListener('click', () => {
            tabPartial.classList.add('active');
            tabTotal.classList.remove('active');
            contentPartial.classList.add('active');
            contentTotal.classList.remove('active');
        });

        document.getElementById('confirmPaymentBtn').addEventListener('click', async (e) => {
            const button = e.currentTarget;
            const amountInput = document.getElementById('partial-amount');
            amountInput.classList.remove('input-error');

            const property = condominioData.find(p => p.id === currentPropertyIdForAction);
            if (!property) return;

            const isPartialPayment = tabPartial.classList.contains('active');
            const currentDebt = property['Deuda Restante'] || 0;
            let paymentAmount = 0;

            if (isPartialPayment) {
                paymentAmount = parseFloat(amountInput.value);
                if (isNaN(paymentAmount) || paymentAmount <= 0) {
                    showToast('Por favor, ingrese un monto v√°lido.', true);
                    amountInput.classList.add('input-error');
                    return;
                }
            } else {
                paymentAmount = currentDebt;
            }
            
            button.disabled = true;
            button.innerHTML = '<div class="spinner mx-auto" style="width: 20px; height: 20px; border-width: 2px;"></div>';

            const paymentRecord = {
                'Monto Pagado': paymentAmount,
                'Fecha de Pago': new Date().toISOString().slice(0, 10),
                'Propietario que Paga': [property.id]
            };
            
            const createResult = await createAirtableRecord(AIRTABLE_TABLE_PAGOS, paymentRecord);

            if (createResult && !createResult.error) {
                showToast('‚úÖ Pago registrado. Actualizando datos...');
                hideModal(paymentModalEl, paymentModalContentEl);
                initApp();
            } else {
                showToast('‚ùå Error al registrar el pago en Airtable.', true);
            }
            button.disabled = false;
            button.textContent = 'Registrar Pago';
        });

        document.getElementById('send-whatsapp-btn').addEventListener('click', () => {
            const property = condominioData.find(p => p.id === currentPropertyIdForAction);
            if (!property || !property.Telefono) {
                showToast('Este propietario no tiene un n√∫mero de tel√©fono registrado.', true);
                return;
            }
            
            const message = document.getElementById('reminder-message-content').textContent;
            if (message.includes('generar un mensaje')) {
                showToast('Por favor, genera un mensaje con la IA antes de enviarlo.', true);
                return;
            }
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://web.whatsapp.com/send?phone=${property.Telefono}&text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
            
            hideModal(reminderModalEl, reminderModalContentEl);
        });

        // --- Gemini Feature Event Listeners ---
        document.getElementById('generate-summary-btn').addEventListener('click', async () => {
            const container = document.getElementById('ai-summary-container');
            const contentEl = document.getElementById('ai-summary-content');
            
            container.classList.remove('hidden');
            contentEl.innerHTML = '<div class="flex justify-center items-center"><div class="spinner"></div></div>';

            const deudaTotal = document.getElementById('kpi-deuda-total').textContent;
            const propietariosMora = document.getElementById('kpi-propietarios-mora').textContent;
            const solvencia = document.getElementById('kpi-solvencia').textContent;

            const prompt = `Act√∫a como un administrador de condominios. Basado en los siguientes datos:
- Deuda Total: ${deudaTotal}
- Propietarios en Mora: ${propietariosMora}
- Porcentaje de Solvencia: ${solvencia}
Escribe un resumen corto y claro (m√°ximo 2 p√°rrafos) sobre el estado financiero del condominio. Usa un tono profesional pero f√°cil de entender para los propietarios.`;

            const summary = await callGemini(prompt);
            contentEl.textContent = summary;
        });

        document.getElementById('generate-reminder-btn').addEventListener('click', async () => {
            if (!currentPropertyIdForAction) return;

            const contentEl = document.getElementById('reminder-message-content');
            contentEl.innerHTML = '<div class="flex justify-center items-center"><div class="spinner"></div></div>';

            const property = condominioData.find(p => p.id === currentPropertyIdForAction);
            const totalFinal = property['Deuda Restante'] || 0;
            const fechaActualStr = new Date().toLocaleDateString('es-VE');
            
            const prompt = `Act√∫a como un administrador de condominios. Genera un mensaje de recordatorio de pago para WhatsApp con el siguiente formato EXACTO y datos. No agregues ninguna palabra o formato adicional. Usa saltos de l√≠nea donde se indique.

Recordatorio de Pago

üìÖ Mensaje generado autom√°ticamente el ${fechaActualStr}.

Estimado/a ${property.Propietario}, seg√∫n nuestro registro, usted presenta un saldo pendiente.

TOTAL A PAGAR: $${totalFinal.toFixed(2)}

Le solicitamos cordialmente ponerse al d√≠a a la brevedad posible para evitar la suspensi√≥n de servicios.

Este es un mensaje automatizado. No responda a este n√∫mero.

Atentamente,
Junta de Condominio Villa Los Apamates`;
            
            const message = await callGemini(prompt);
            contentEl.textContent = message;
        });
        
        document.getElementById('update-monthly-charges-btn').addEventListener('click', async () => {
            showToast("Actualizando cargos mensuales para todos los propietarios... Esto puede tardar un momento.");

            const updates = condominioData.map(property => {
                const { cuotaComun, cuotaEspecial, beneficio } = calculateCurrentMonthCharges(property);
                const currentMonthCharge = cuotaComun + cuotaEspecial;
                const finalMonthlyCharge = (new Date().getDate() <= DIA_LIMITE_PAGO) ? currentMonthCharge - beneficio : currentMonthCharge;

                const currentAccumulatedCharges = property['Cargos Acumulados'] || 0;
                const newAccumulatedCharges = currentAccumulatedCharges + finalMonthlyCharge;
                
                return {
                    id: property.id,
                    fields: {
                        'Cargos Acumulados': newAccumulatedCharges
                    }
                };
            });

            const chunkSize = 10;
            let successCount = 0;
            for (let i = 0; i < updates.length; i += chunkSize) {
                const chunk = updates.slice(i, i + chunkSize);
                try {
                    const result = await updateAirtableRecords(AIRTABLE_TABLE_PROPIETARIOS, chunk);
                    if (!result) {
                         throw new Error(`Error en el lote ${i/chunkSize + 1}`);
                    }
                    successCount += chunk.length;
                } catch (error) {
                    showToast(`‚ùå Error al actualizar un lote de registros. ${error.message}`, true);
                    return;
                }
            }
            
            showToast(`‚úÖ Proceso completado. Se actualizaron ${successCount} registros. Recargando...`);
            setTimeout(() => initApp(), 1500);
        });

        document.getElementById('add-expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const conceptInput = document.getElementById('expense-concept');
            const amountInput = document.getElementById('expense-amount');
            conceptInput.classList.remove('input-error');
            amountInput.classList.remove('input-error');

            const newExpense = {
                'Concepto': conceptInput.value.trim(),
                'Monto': parseFloat(amountInput.value),
                'Tipo de Gasto': document.getElementById('expense-type').value,
                'Frecuencia': document.getElementById('expense-frequency').value
            };

            if (!newExpense.Concepto || isNaN(newExpense.Monto) || newExpense.Monto <= 0) {
                showToast('Por favor, introduce un concepto y un monto v√°lido.', true);
                if (!newExpense.Concepto) conceptInput.classList.add('input-error');
                if (isNaN(newExpense.Monto) || newExpense.Monto <= 0) amountInput.classList.add('input-error');
                return;
            }

            const selectedOwners = [];
            document.querySelectorAll('#expense-owners-list input[type="checkbox"]:checked').forEach(checkbox => {
                selectedOwners.push(checkbox.value);
            });

            if (selectedOwners.length === 0) {
                showToast('Debe seleccionar al menos un propietario para asignar el gasto.', true);
                return;
            }
            newExpense['Propietarios'] = selectedOwners;

            const button = e.target.querySelector('button');
            button.disabled = true;
            button.innerHTML = '<div class="spinner mx-auto" style="width: 20px; height: 20px; border-width: 2px;"></div>';

            const result = await createAirtableRecord(AIRTABLE_TABLE_GASTOS, newExpense);
            
            if (result && !result.error) {
                showToast('‚úÖ Gasto a√±adido correctamente. Actualizando...');
                e.target.reset();
                initApp(); // Refresh data without full reload
            } else {
                if (result.error?.type === 'INVALID_MULTIPLE_CHOICE_OPTIONS') {
                    showToast('‚ùå Error: Las opciones de gasto no existen en Airtable. Verif√≠calas.', true);
                } else {
                    showToast(`‚ùå Error al a√±adir el gasto: ${result.error?.message || 'Error desconocido'}`, true);
                }
            }
            button.disabled = false;
            button.textContent = 'A√±adir Gasto';
        });

        document.getElementById('expensesTableBody').addEventListener('click', async (e) => {
            const button = e.target.closest('.delete-expense-btn');
            if (button) {
                const recordId = button.dataset.id;
                const result = await deleteAirtableRecord(AIRTABLE_TABLE_GASTOS, recordId);
                if (result && result.deleted) {
                    showToast('‚úÖ Gasto eliminado. Actualizando...');
                    initApp(); // Refresh data without full reload
                } else {
                    showToast('‚ùå Error al eliminar el gasto.', true);
                }
            }
        });

        document.getElementById('expense-type').addEventListener('change', (e) => {
            const toggleButton = document.getElementById('toggle-all-owners');
            const checkboxes = document.querySelectorAll('#expense-owners-list input[type="checkbox"]');

            if (e.target.value === 'Gasto Com√∫n') {
                checkboxes.forEach(cb => cb.checked = true);
                toggleButton.textContent = 'Deseleccionar Todos';
            } else { // Gasto Especial
                checkboxes.forEach(cb => cb.checked = false);
                toggleButton.textContent = 'Seleccionar Todos';
            }
        });

        document.getElementById('expense-concept').addEventListener('keyup', (e) => {
            const concept = e.target.value.toLowerCase();
            const expenseType = document.getElementById('expense-type').value;

            if (expenseType === 'Gasto Especial' && concept.includes('gasoil')) {
                const checkboxes = document.querySelectorAll('#expense-owners-list input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    const owner = condominioData.find(p => p.id === checkbox.value);
                    checkbox.checked = !!(owner && owner['Paga Gasoil']);
                });
            }
        });

        document.getElementById('toggle-all-owners').addEventListener('click', (e) => {
            const button = e.target;
            const checkboxes = document.querySelectorAll('#expense-owners-list input[type="checkbox"]');
            const areAllChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(checkbox => {
                checkbox.checked = !areAllChecked;
            });

            button.textContent = areAllChecked ? 'Seleccionar Todos' : 'Deseleccionar Todos';
        });

        document.getElementById('analyze-expenses-btn').addEventListener('click', async () => {
            const contentEl = document.getElementById('analysis-content');
            showModal(aiHelpModal, aiHelpModalContent);
            aiHelpModalTitle.textContent = 'An√°lisis de Gastos del Mes';
            contentEl.innerHTML = '<div class="flex justify-center items-center h-full"><div class="spinner"></div></div>';

            const expensesText = gastosDelMes.map(g => `- ${g.fields.Concepto}: $${(g.fields.Monto || 0).toFixed(2)} (${g.fields['Tipo de Gasto']})`).join('\n');
            const prompt = `Act√∫a como un analista financiero para un condominio. Analiza la siguiente lista de gastos del mes. 
            
            Gastos:
            ${expensesText}

            Proporciona un resumen claro en espa√±ol que incluya:
            1. Un resumen ejecutivo de los gastos totales.
            2. Identifica las 2-3 categor√≠as o conceptos de gasto m√°s altos.
            3. Ofrece una breve conclusi√≥n o recomendaci√≥n para la junta de condominio.
            
            Usa un formato limpio con t√≠tulos y vi√±etas.`;

            const analysis = await callGemini(prompt);
            contentEl.textContent = analysis;
        });

        document.getElementById('generate-announcement-modal-btn').addEventListener('click', () => {
            document.getElementById('announcement-topic').value = '';
            document.getElementById('announcement-result').value = '';
            showModal(announcementModal, announcementModalContent);
        });

        document.getElementById('generate-announcement-btn').addEventListener('click', async (e) => {
            const button = e.currentTarget;
            const topic = document.getElementById('announcement-topic').value;
            const resultTextarea = document.getElementById('announcement-result');
            
            if (!topic.trim()) {
                showToast('Por favor, introduce un tema para el anuncio.', true);
                return;
            }

            button.disabled = true;
            button.innerHTML = '<div class="spinner mx-auto" style="width: 20px; height: 20px; border-width: 2px;"></div>';
            resultTextarea.value = 'Generando...';

            const prompt = `Act√∫a como el administrador del Condominio "Villa Los Apamates". Redacta un anuncio claro, profesional y amigable para los residentes sobre el siguiente tema: "${topic}". 
            
            El anuncio debe tener:
            - Un t√≠tulo claro.
            - Una breve introducci√≥n.
            - Los detalles importantes (si aplica, inventa fechas o detalles l√≥gicos).
            - Una despedida cordial firmada por "La Junta de Condominio".`;
            
            const announcement = await callGemini(prompt);
            resultTextarea.value = announcement;
            button.disabled = false;
            button.innerHTML = '‚ú® Generar Anuncio con IA';
        });
        
        initApp();
    </script>
</body>
</html>
