<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Condominio VLA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background-color: #343a40; }
        .nav-link { color: #f8f9fa !important; margin: 0 10px; }
        .nav-link.active { font-weight: bold; border-bottom: 2px solid #0d6efd; }
        .card-header { background-color: #007bff; color: white; }
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div id="loader" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Gestión VLA</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link active" href="#" onclick="showView('dashboard')">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showView('gestionGastos')">Gestión de Gastos</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div id="dashboard" class="view">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 id="currentMonthYear"></h2>
                <button class="btn btn-danger" id="updateChargesBtn">
                    <i class="bi bi-calculator"></i> Actualizar Cargos del Mes
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Casa</th>
                            <th>Propietario</th>
                            <th>Deuda Restante</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="propietarios-table"></tbody>
                </table>
            </div>
        </div>

        <div id="gestionGastos" class="view" style="display: none;">
            <h3>Registrar Nuevo Gasto</h3>
            <div class="card mb-4">
                <div class="card-body">
                    <form id="add-gasto-form">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="gasto-concepto" class="form-label">Concepto</label>
                                <input type="text" class="form-control" id="gasto-concepto" required>
                            </div>
                            <div class="col-md-6">
                                <label for="gasto-monto" class="form-label">Monto ($)</label>
                                <input type="number" step="0.01" class="form-control" id="gasto-monto" required>
                            </div>
                            <div class="col-md-6">
                                <label for="gasto-tipo" class="form-label">Tipo de Gasto</label>
                                <select class="form-select" id="gasto-tipo" required>
                                    <option value="Gasto Común">Gasto Común</option>
                                    <option value="Gasto Especial">Gasto Especial</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="gasto-frecuencia" class="form-label">Frecuencia</label>
                                <select class="form-select" id="gasto-frecuencia" required>
                                    <option value="Eventual">Eventual</option>
                                    <option value="Fijo">Fijo</option>
                                </select>
                            </div>
                        </div>
                        <div id="propietarios-selector-container" class="mt-3" style="display: none;">
                            <h5>Asignar Gasto a Propietarios</h5>
                            <button type="button" class="btn btn-secondary btn-sm mb-2" onclick="toggleAllPropietarios(true)">Seleccionar Todos</button>
                            <button type="button" class="btn btn-secondary btn-sm mb-2" onclick="toggleAllPropietarios(false)">Deseleccionar Todos</button>
                            <div id="propietarios-checkboxes" class="row"></div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Añadir Gasto</button>
                    </form>
                </div>
            </div>
            <h3>Gastos Registrados del Mes</h3>
             <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr><th>Concepto</th><th>Monto</th><th>Tipo</th><th>Frecuencia</th><th>Acción</th></tr>
                    </thead>
                    <tbody id="gastos-mes-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="paymentModalTitle">Registrar Pago</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="payment-form">
              <input type="hidden" id="propietario-id">
              <div class="mb-3">
                <label for="payment-amount" class="form-label">Monto a Pagar ($)</label>
                <input type="number" step="0.01" class="form-control" id="payment-amount" required>
              </div>
              <div class="mb-3">
                <label for="payment-method" class="form-label">Método de Pago</label>
                <select class="form-select" id="payment-method">
                  <option>Zelle</option>
                  <option>Efectivo</option>
                  <option>Transferencia</option>
                  <option>Pago Móvil</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">Registrar</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalTitle">Desglose de Deuda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Saldo del Mes Anterior:</strong> <span id="saldo-anterior"></span></p>
                    <p><strong>Cuota Común del Mes:</strong> <span id="cuota-mes"></span></p>
                    <hr>
                    <p><strong>TOTAL A PAGAR HOY:</strong> <span id="total-pagar" class="fw-bold fs-5"></span></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const apiUrl = '/.netlify/functions/airtable'; 
        let currentView = 'dashboard';
        let allPropietarios = [];
        let config = {};

        const loader = document.getElementById('loader');

        // --- NAVEGACIÓN ---
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById(viewName).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-link[onclick="showView('${viewName}')"]`).classList.add('active');
            currentView = viewName;
            sessionStorage.setItem('currentView', viewName);
        }

        // --- LÓGICA DE DATOS ---
        async function fetchData(endpoint) {
            const url = `${apiUrl}${endpoint}`;
            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Error de Airtable: ${errorData.error?.message || response.statusText}`);
            }
            return response.json();
        }
        
        async function postData(endpoint, data) {
            const url = `${apiUrl}${endpoint}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fields: data })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Error al enviar a Airtable: ${errorData.error?.message || response.statusText}`);
            }
            return response.json();
        }

        async function patchData(endpoint, data) {
            const url = `${apiUrl}${endpoint}`;
            const response = await fetch(url, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fields: data })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Error al actualizar en Airtable: ${errorData.error?.message || response.statusText}`);
            }
            return response.json();
        }

        async function deleteData(endpoint) {
            const url = `${apiUrl}${endpoint}`;
            const response = await fetch(url, { method: 'DELETE' });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Error al eliminar de Airtable: ${errorData.error?.message || response.statusText}`);
            }
            return response.json();
        }
        
        async function loadInitialData() {
            loader.style.display = 'flex';
            try {
                const [propietariosData, gastosData, configData] = await Promise.all([
                    fetchData('/Propietarios?view=Grid%20view'),
                    fetchData('/Gastos%20del%20Mes?view=Gastos%20Mensuales'),
                    fetchData('/Configuracion')
                ]);

                allPropietarios = propietariosData.records;
                config = configData.records[0].fields;
                
                renderPropietarios(allPropietarios);
                renderGastos(gastosData.records);
                renderPropietariosSelector(allPropietarios);
                updateCurrentMonthYear();
            } catch (error) {
                alert(`Hubo un error al cargar los datos: ${error.message}. Revisa la consola (F12) para más detalles.`);
                console.error(error);
            } finally {
                loader.style.display = 'none';
                const savedView = sessionStorage.getItem('currentView');
                if (savedView) {
                    showView(savedView);
                }
            }
        }
        
        function updateCurrentMonthYear() {
            const date = new Date();
            const monthName = date.toLocaleString('es-ES', { month: 'long' });
            const year = date.getFullYear();
            document.getElementById('currentMonthYear').textContent = `Dashboard - ${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}`;
        }

        // --- RENDERIZADO ---
        function renderPropietarios(propietarios) {
            const tableBody = document.getElementById('propietarios-table');
            tableBody.innerHTML = '';
            propietarios.sort((a, b) => a.fields.Casa.localeCompare(b.fields.Casa)).forEach(p => {
                const deuda = p.fields['Deuda Restante'] || 0;
                tableBody.innerHTML += `
                    <tr>
                        <td>${p.fields.Casa}</td>
                        <td>${p.fields.Propietario}</td>
                        <td>$${deuda.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="openPaymentModal('${p.id}', '${deuda}')">Pagar</button>
                            <button class="btn btn-info btn-sm" onclick="showDetails('${p.id}')">Ver Desglose</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        function renderGastos(gastos) {
            const tableBody = document.getElementById('gastos-mes-table');
            tableBody.innerHTML = '';
            gastos.forEach(g => {
                tableBody.innerHTML += `
                    <tr id="gasto-${g.id}">
                        <td>${g.fields.Concepto}</td>
                        <td>$${g.fields.Monto.toFixed(2)}</td>
                        <td>${g.fields['Tipo de Gasto']}</td>
                        <td>${g.fields.Frecuencia}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="deleteGasto('${g.id}')">X</button></td>
                    </tr>
                `;
            });
        }

        function renderPropietariosSelector(propietarios) {
            const container = document.getElementById('propietarios-checkboxes');
            container.innerHTML = '';
            propietarios.forEach(p => {
                container.innerHTML += `
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${p.id}" id="prop-${p.id}">
                            <label class="form-check-label" for="prop-${p.id}">${p.fields.Casa} - ${p.fields.Propietario}</label>
                        </div>
                    </div>
                `;
            });
        }

        // --- LÓGICA DE ACCIONES ---
        function openPaymentModal(propietarioId, deuda) {
            document.getElementById('propietario-id').value = propietarioId;
            document.getElementById('payment-amount').value = parseFloat(deuda).toFixed(2);
            new bootstrap.Modal(document.getElementById('paymentModal')).show();
        }

        async function showDetails(propietarioId) {
            const propietario = allPropietarios.find(p => p.id === propietarioId);
            if (propietario) {
                const deudaAnterior = propietario.fields['Deuda Anterior'] || 0;
                const cuotaMes = (propietario.fields['Cargos Acumulados'] || 0) - deudaAnterior;
                const totalPagar = propietario.fields['Deuda Restante'] || 0;
                
                document.getElementById('detailsModalTitle').innerText = `Desglose de Deuda - ${propietario.fields.Casa}`;
                document.getElementById('saldo-anterior').innerText = `$${deudaAnterior.toFixed(2)}`;
                document.getElementById('cuota-mes').innerText = `$${cuotaMes.toFixed(2)}`;
                document.getElementById('total-pagar').innerText = `$${totalPagar.toFixed(2)}`;
                new bootstrap.Modal(document.getElementById('detailsModal')).show();
            }
        }
        
        document.getElementById('payment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            loader.style.display = 'flex';
            const propietarioId = document.getElementById('propietario-id').value;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const method = document.getElementById('payment-method').value;
            const date = new Date().toISOString().split('T')[0];

            try {
                // 1. Registrar el pago en la tabla "Pagos"
                await postData('/Pagos', {
                    'Monto Pagado': amount,
                    'Fecha de Pago': date,
                    'Metodo de Pago': method,
                    'Propietario que Paga': [propietarioId]
                });
                
                // 2. Actualizar la deuda del propietario (Airtable se encarga vía Rollup y Fórmulas)
                // Damos un tiempo prudencial para que Airtable recalcule
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    loadInitialData(); // Recargamos todo para reflejar los cambios
                }, 2000);

            } catch (error) {
                alert(`Error al registrar el pago: ${error.message}`);
                loader.style.display = 'none';
            }
        });
        
        document.getElementById('add-gasto-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            loader.style.display = 'flex';
            
            const concepto = document.getElementById('gasto-concepto').value;
            const monto = parseFloat(document.getElementById('gasto-monto').value);
            const tipo = document.getElementById('gasto-tipo').value;
            const frecuencia = document.getElementById('gasto-frecuencia').value;
            
            let propietariosAsignados = [];
            if (document.getElementById('propietarios-selector-container').style.display !== 'none') {
                document.querySelectorAll('#propietarios-checkboxes input:checked').forEach(cb => {
                    propietariosAsignados.push(cb.value);
                });
            }

            const gastoData = {
                Concepto: concepto,
                Monto: monto,
                "Tipo de Gasto": tipo,
                Frecuencia: frecuencia
            };
            
            if (propietariosAsignados.length > 0) {
                 gastoData.Propietarios = propietariosAsignados;
            }

            try {
                await postData('/Gastos%20del%20Mes', gastoData);
                this.reset();
                document.getElementById('propietarios-selector-container').style.display = 'none';
                loadInitialData();
            } catch (error) {
                alert(`Error al añadir el gasto: ${error.message}`);
                loader.style.display = 'none';
            }
        });
        
        async function deleteGasto(gastoId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este gasto?')) return;
            loader.style.display = 'flex';
            try {
                await deleteData(`/Gastos%20del%20Mes/${gastoId}`);
                loadInitialData();
            } catch (error) {
                alert(`Error al eliminar el gasto: ${error.message}`);
                loader.style.display = 'none';
            }
        }
        
        document.getElementById('updateChargesBtn').addEventListener('click', async () => {
            if (!confirm('¡ATENCIÓN! Esta acción cerrará el mes y calculará la deuda final para TODOS los propietarios. ¿Estás seguro de que quieres continuar?')) return;
            
            loader.style.display = 'flex';
            try {
                // 1. Actualizar "Deuda Anterior" para todos
                const updatesPaso1 = allPropietarios.map(p => ({
                    id: p.id,
                    fields: { 'Deuda Anterior': p.fields['Deuda Restante'] || 0 }
                }));
                await patchData('/Propietarios', { records: updatesPaso1 });

                // 2. Obtener gastos actualizados
                const gastosData = await fetchData('/Gastos%20del%20Mes?view=Gastos%20Mensuales');
                const gastos = gastosData.records;
                
                // 3. Calcular nuevos cargos
                const totalGastoComun = gastos
                    .filter(g => g.fields['Tipo de Gasto'] === 'Gasto Común')
                    .reduce((sum, g) => sum + g.fields.Monto, 0);

                const updatesPaso2 = allPropietarios.map(p => {
                    const deudaAnterior = p.fields['Deuda Restante'] || 0;
                    const cuotaComun = totalGastoComun * (p.fields.Alicuota / 100);

                    let cuotaEspecial = 0;
                    gastos.filter(g => g.fields['Tipo de Gasto'] === 'Gasto Especial' && g.fields.Propietarios?.includes(p.id))
                          .forEach(gastoEspecial => {
                              const numPropietarios = gastoEspecial.fields.Propietarios.length;
                              cuotaEspecial += gastoEspecial.fields.Monto / numPropietarios;
                          });
                    
                    const nuevosCargos = deudaAnterior + cuotaComun + cuotaEspecial;
                    return {
                        id: p.id,
                        fields: { 'Cargos Acumulados': nuevosCargos }
                    };
                });
                
                // 4. Aplicar nuevos cargos
                await patchData('/Propietarios', { records: updatesPaso2 });

                // 5. Esperar recálculos de Airtable y recargar
                setTimeout(() => {
                    alert('¡Cierre de mes completado! Las deudas han sido actualizadas.');
                    loadInitialData();
                }, 3000);

            } catch (error) {
                alert(`Error al actualizar los cargos: ${error.message}`);
                loader.style.display = 'none';
            }
        });

        document.getElementById('gasto-tipo').addEventListener('change', function() {
            const selectorContainer = document.getElementById('propietarios-selector-container');
            if (this.value === 'Gasto Común' || this.value === 'Gasto Especial') {
                selectorContainer.style.display = 'block';
                const isGastoComun = this.value === 'Gasto Común';
                toggleAllPropietarios(isGastoComun); // Seleccionar todos si es común
            } else {
                selectorContainer.style.display = 'none';
            }
        });

        function toggleAllPropietarios(select) {
            document.querySelectorAll('#propietarios-checkboxes input').forEach(cb => cb.checked = select);
        }

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', loadInitialData);
    </script>
</body>
</html>
