<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Condominio VLA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background-color: #343a40; }
        .nav-link { color: #f8f9fa !important; margin: 0 10px; }
        .nav-link.active { font-weight: bold; border-bottom: 2px solid #0d6efd; }
        .card-header { background-color: #007bff; color: white; }
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        #login-container {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>
    <div id="login-container">
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <h3 class="text-center mb-4">Acceso de Administrador</h3>
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="password" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Entrar</button>
                        </div>
                    </form>
                    <div id="login-error" class="alert alert-danger mt-3 d-none">Contraseña incorrecta.</div>
                </div>
            </div>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <div id="loader" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Gestión VLA</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a class="nav-link active" href="#" onclick="showView('dashboard')">Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" onclick="showView('gestionGastos')">Gestión de Gastos</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <div id="dashboard" class="view">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 id="currentMonthYear"></h2>
                    <button class="btn btn-danger" id="updateChargesBtn">
                        <i class="bi bi-calculator"></i> Actualizar Cargos del Mes
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr><th>Casa</th><th>Propietario</th><th>Deuda Restante</th><th>Acciones</th></tr>
                        </thead>
                        <tbody id="propietarios-table"></tbody>
                    </table>
                </div>
            </div>

            <div id="gestionGastos" class="view" style="display: none;">
                <h3>Registrar Nuevo Gasto</h3>
                <div class="card mb-4">
                    <div class="card-body">
                        <form id="add-gasto-form">
                            <div class="row g-3">
                                <div class="col-md-6"><label for="gasto-concepto" class="form-label">Concepto</label><input type="text" class="form-control" id="gasto-concepto" required></div>
                                <div class="col-md-6"><label for="gasto-monto" class="form-label">Monto ($)</label><input type="number" step="0.01" class="form-control" id="gasto-monto" required></div>
                                <div class="col-md-6"><label for="gasto-tipo" class="form-label">Tipo de Gasto</label><select class="form-select" id="gasto-tipo" required><option value="Gasto Común">Gasto Común</option><option value="Gasto Especial">Gasto Especial</option></select></div>
                                <div class="col-md-6"><label for="gasto-frecuencia" class="form-label">Frecuencia</label><select class="form-select" id="gasto-frecuencia" required><option value="Eventual">Eventual</option><option value="Fijo">Fijo</option></select></div>
                            </div>
                            <div id="propietarios-selector-container" class="mt-3" style="display: none;">
                                <h5>Asignar Gasto a Propietarios</h5>
                                <button type="button" class="btn btn-secondary btn-sm mb-2" onclick="toggleAllPropietarios(true)">Seleccionar Todos</button>
                                <button type="button" class="btn btn-secondary btn-sm mb-2" onclick="toggleAllPropietarios(false)">Deseleccionar Todos</button>
                                <div id="propietarios-checkboxes" class="row"></div>
                            </div>
                            <button type="submit" class="btn btn-primary mt-3">Añadir Gasto</button>
                        </form>
                    </div>
                </div>
                <h3>Gastos Registrados del Mes</h3>
                 <div class="table-responsive">
                    <table class="table table-sm"><thead><tr><th>Concepto</th><th>Monto</th><th>Tipo</th><th>Frecuencia</th><th>Acción</th></tr></thead><tbody id="gastos-mes-table"></tbody></table>
                </div>
            </div>
        </div>

        <div class="modal fade" id="paymentModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="paymentModalTitle">Registrar Pago</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="payment-form"><input type="hidden" id="propietario-id"><div class="mb-3"><label for="payment-amount" class="form-label">Monto a Pagar ($)</label><input type="number" step="0.01" class="form-control" id="payment-amount" required></div><div class="mb-3"><label for="payment-method" class="form-label">Método de Pago</label><select class="form-select" id="payment-method"><option>Zelle</option><option>Efectivo</option><option>Transferencia</option><option>Pago Móvil</option></select></div><button type="submit" class="btn btn-primary">Registrar</button></form></div></div></div></div>
        <div class="modal fade" id="detailsModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="detailsModalTitle">Desglose de Deuda</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p><strong>Saldo del Mes Anterior:</strong> <span id="saldo-anterior"></span></p><p><strong>Cuota Común del Mes:</strong> <span id="cuota-mes"></span></p><hr><p><strong>TOTAL A PAGAR HOY:</strong> <span id="total-pagar" class="fw-bold fs-5"></span></p></div></div></div></div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- LÓGICA DE AUTENTICACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Revisa si el usuario ya está logueado en esta sesión
            if (sessionStorage.getItem('vla-admin-auth') === 'true') {
                showMainContent();
            }

            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const password = document.getElementById('password').value;
                const errorDiv = document.getElementById('login-error');
                errorDiv.classList.add('d-none');

                try {
                    const response = await fetch('/.netlify/functions/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: password })
                    });
                    
                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Guardar estado de autenticación en la sesión del navegador
                        sessionStorage.setItem('vla-admin-auth', 'true');
                        showMainContent();
                    } else {
                        errorDiv.classList.remove('d-none');
                    }
                } catch (error) {
                    errorDiv.textContent = 'Error de conexión. Inténtalo de nuevo.';
                    errorDiv.classList.remove('d-none');
                }
            });
        });

        function showMainContent() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            loadInitialData(); // Carga los datos solo después del login exitoso
        }

        // --- LÓGICA PRINCIPAL DE LA APLICACIÓN ---
        const apiUrl = '/.netlify/functions/airtable'; 
        let currentView = 'dashboard';
        let allPropietarios = [];
        let config = {};

        const loader = document.getElementById('loader');

        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById(viewName).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-link[onclick="showView('${viewName}')"]`).classList.add('active');
            currentView = viewName;
            sessionStorage.setItem('currentView', viewName);
        }

        async function fetchData(endpoint) {
            const response = await fetch(`${apiUrl}${endpoint}`);
            if (!response.ok) throw new Error(`Error de Airtable: ${(await response.json()).error?.message}`);
            return response.json();
        }
        
        async function postData(endpoint, data) {
            const response = await fetch(`${apiUrl}${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fields: data }) });
            if (!response.ok) throw new Error(`Error al enviar a Airtable: ${(await response.json()).error?.message}`);
            return response.json();
        }

        async function patchData(endpoint, data) {
            const response = await fetch(`${apiUrl}${endpoint}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ records: data }) });
             if (!response.ok) throw new Error(`Error al actualizar en Airtable: ${(await response.json()).error?.message}`);
            return response.json();
        }

        async function deleteData(endpoint) {
            const response = await fetch(`${apiUrl}${endpoint}`, { method: 'DELETE' });
            if (!response.ok) throw new Error(`Error al eliminar de Airtable: ${(await response.json()).error?.message}`);
            return response.json();
        }
        
        async function loadInitialData() {
            loader.style.display = 'flex';
            try {
                const [propietariosData, gastosData, configData] = await Promise.all([
                    fetchData('/Propietarios?view=Grid%20view'),
                    fetchData('/Gastos%20del%20Mes?view=Gastos%20Mensuales'),
                    fetchData('/Configuracion')
                ]);

                allPropietarios = propietariosData.records;
                config = configData.records[0].fields;
                
                renderPropietarios(allPropietarios);
                renderGastos(gastosData.records);
                renderPropietariosSelector(allPropietarios);
                updateCurrentMonthYear();
            } catch (error) {
                alert(`Hubo un error al cargar los datos: ${error.message}. Revisa la consola (F12).`);
            } finally {
                loader.style.display = 'none';
                const savedView = sessionStorage.getItem('currentView');
                if (savedView) showView(savedView);
            }
        }
        
        function updateCurrentMonthYear() {
            const date = new Date();
            const monthName = date.toLocaleString('es-ES', { month: 'long' });
            document.getElementById('currentMonthYear').textContent = `Dashboard - ${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${date.getFullYear()}`;
        }

        function renderPropietarios(propietarios) {
            const tableBody = document.getElementById('propietarios-table');
            tableBody.innerHTML = '';
            propietarios.sort((a, b) => a.fields.Casa.localeCompare(b.fields.Casa)).forEach(p => {
                const deuda = p.fields['Deuda Restante'] || 0;
                tableBody.innerHTML += `<tr><td>${p.fields.Casa}</td><td>${p.fields.Propietario}</td><td>$${deuda.toFixed(2)}</td><td><button class="btn btn-success btn-sm" onclick="openPaymentModal('${p.id}', '${deuda}')">Pagar</button> <button class="btn btn-info btn-sm" onclick="showDetails('${p.id}')">Ver Desglose</button></td></tr>`;
            });
        }
        
        function renderGastos(gastos) {
            const tableBody = document.getElementById('gastos-mes-table');
            tableBody.innerHTML = '';
            gastos.forEach(g => {
                tableBody.innerHTML += `<tr id="gasto-${g.id}"><td>${g.fields.Concepto}</td><td>$${g.fields.Monto.toFixed(2)}</td><td>${g.fields['Tipo de Gasto']}</td><td>${g.fields.Frecuencia}</td><td><button class="btn btn-danger btn-sm" onclick="deleteGasto('${g.id}')">X</button></td></tr>`;
            });
        }

        function renderPropietariosSelector(propietarios) {
            const container = document.getElementById('propietarios-checkboxes');
            container.innerHTML = '';
            propietarios.forEach(p => { container.innerHTML += `<div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" value="${p.id}" id="prop-${p.id}"><label class="form-check-label" for="prop-${p.id}">${p.fields.Casa} - ${p.fields.Propietario}</label></div></div>`; });
        }

        function openPaymentModal(propietarioId, deuda) {
            document.getElementById('propietario-id').value = propietarioId;
            document.getElementById('payment-amount').value = parseFloat(deuda).toFixed(2);
            new bootstrap.Modal(document.getElementById('paymentModal')).show();
        }

        async function showDetails(propietarioId) {
            const p = allPropietarios.find(prop => prop.id === propietarioId);
            if(p){
                const deudaAnterior = p.fields['Deuda Anterior'] || 0;
                const cuotaMes = (p.fields['Cargos Acumulados'] || 0) - deudaAnterior;
                document.getElementById('detailsModalTitle').innerText = `Desglose de Deuda - ${p.fields.Casa}`;
                document.getElementById('saldo-anterior').innerText = `$${deudaAnterior.toFixed(2)}`;
                document.getElementById('cuota-mes').innerText = `$${cuotaMes.toFixed(2)}`;
                document.getElementById('total-pagar').innerText = `$${(p.fields['Deuda Restante'] || 0).toFixed(2)}`;
                new bootstrap.Modal(document.getElementById('detailsModal')).show();
            }
        }
        
        document.getElementById('payment-form').addEventListener('submit', async function(e) {
            e.preventDefault(); loader.style.display = 'flex';
            const propietarioId = document.getElementById('propietario-id').value;
            try {
                await postData('/Pagos', {
                    'Monto Pagado': parseFloat(document.getElementById('payment-amount').value),
                    'Fecha de Pago': new Date().toISOString().split('T')[0],
                    'Metodo de Pago': document.getElementById('payment-method').value,
                    'Propietario que Paga': [propietarioId]
                });
                setTimeout(() => { bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide(); loadInitialData(); }, 2000);
            } catch (error) { alert(`Error al registrar el pago: ${error.message}`); loader.style.display = 'none'; }
        });
        
        document.getElementById('add-gasto-form').addEventListener('submit', async function(e) {
            e.preventDefault(); loader.style.display = 'flex';
            let propietariosAsignados = [];
            if (document.getElementById('propietarios-selector-container').style.display !== 'none') {
                document.querySelectorAll('#propietarios-checkboxes input:checked').forEach(cb => propietariosAsignados.push(cb.value));
            }
            const gastoData = {
                Concepto: document.getElementById('gasto-concepto').value,
                Monto: parseFloat(document.getElementById('gasto-monto').value),
                "Tipo de Gasto": document.getElementById('gasto-tipo').value,
                Frecuencia: document.getElementById('gasto-frecuencia').value
            };
            if (propietariosAsignados.length > 0) gastoData.Propietarios = propietariosAsignados;
            try {
                await postData('/Gastos%20del%20Mes', gastoData);
                this.reset();
                document.getElementById('propietarios-selector-container').style.display = 'none';
                loadInitialData();
            } catch (error) { alert(`Error al añadir el gasto: ${error.message}`); loader.style.display = 'none'; }
        });
        
        async function deleteGasto(gastoId) {
            if (!confirm('¿Seguro?')) return;
            loader.style.display = 'flex';
            try { await deleteData(`/Gastos%20del%20Mes/${gastoId}`); loadInitialData(); } 
            catch (error) { alert(`Error al eliminar: ${error.message}`); loader.style.display = 'none'; }
        }
        
        document.getElementById('updateChargesBtn').addEventListener('click', async () => {
            if (!confirm('¡ATENCIÓN! Esto cerrará el mes y calculará la deuda para TODOS. ¿Continuar?')) return;
            loader.style.display = 'flex';
            try {
                const updatesPaso1 = allPropietarios.map(p => ({ id: p.id, fields: { 'Deuda Anterior': p.fields['Deuda Restante'] || 0 } }));
                await patchData('/Propietarios', updatesPaso1);

                const gastos = (await fetchData('/Gastos%20del%20Mes?view=Gastos%20Mensuales')).records;
                const totalGastoComun = gastos.filter(g => g.fields['Tipo de Gasto'] === 'Gasto Común').reduce((s, g) => s + g.fields.Monto, 0);

                const updatesPaso2 = allPropietarios.map(p => {
                    const deudaAnterior = p.fields['Deuda Restante'] || 0;
                    const cuotaComun = totalGastoComun * (p.fields.Alicuota / 100);
                    let cuotaEspecial = 0;
                    gastos.filter(g => g.fields['Tipo de Gasto'] === 'Gasto Especial' && g.fields.Propietarios?.includes(p.id)).forEach(g => { cuotaEspecial += g.fields.Monto / g.fields.Propietarios.length; });
                    return { id: p.id, fields: { 'Cargos Acumulados': deudaAnterior + cuotaComun + cuotaEspecial } };
                });
                
                await patchData('/Propietarios', updatesPaso2);
                setTimeout(() => { alert('¡Cierre de mes completado!'); loadInitialData(); }, 3000);
            } catch (error) { alert(`Error al actualizar cargos: ${error.message}`); loader.style.display = 'none'; }
        });

        document.getElementById('gasto-tipo').addEventListener('change', function() {
            const selectorContainer = document.getElementById('propietarios-selector-container');
            selectorContainer.style.display = 'block';
            toggleAllPropietarios(this.value === 'Gasto Común');
        });

        function toggleAllPropietarios(select) {
            document.querySelectorAll('#propietarios-checkboxes input').forEach(cb => cb.checked = select);
        }
    </script>
</body>
</html>
